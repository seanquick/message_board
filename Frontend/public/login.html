<!-- Frontend/public/login.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign in</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --bg: #0e1726;
      --card: #111c2f;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --brand: #8ab4f8;
      --brand-2: #60a5fa;
      --danger: #ef4444;
      --ring: rgba(138,180,248,.45);
    }
    body {
      margin: 0; min-height: 100dvh;
      display: grid; place-items: center;
      background: radial-gradient(70% 70% at 80% 20%, #11203a 0%, #0e1726 60%, #0b1220 100%);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap { width: 100%; max-width: 420px; padding: 2rem; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px; padding: 1.25rem 1.25rem 1rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h1 { margin: 0 0 .75rem; font-size: 1.25rem; letter-spacing: .2px; }
    p.sub { margin:.25rem 0 1rem; color: var(--muted); font-size: .95rem; }
    label { display:block; font-size:.85rem; color:#cbd5e1; margin:.6rem 0 .35rem; }
    input[type="email"], input[type="password"] {
      width:100%; padding:.75rem .8rem; border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:#0c1526; color:var(--text);
      outline: none; transition:.15s border-color, .15s box-shadow;
    }
    input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .row { display:flex; align-items:center; gap:.5rem; }
    .between { justify-content: space-between; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      color:#0b1220; background: linear-gradient(180deg, var(--brand), var(--brand-2));
      padding:.7rem .9rem; border-radius:10px; font-weight: 600; cursor:pointer;
      transition: transform .06s ease, filter .15s ease;
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px); }
    .btn.ghost {
      background: transparent; color: var(--text);
      border-color: rgba(255,255,255,.16);
    }
    .meta { color: var(--muted); font-size: .9rem; }
    .err {
      margin:.5rem 0 0; color:#fff; background:#37151a;
      border:1px solid rgba(239,68,68,.4); padding:.6rem .7rem; border-radius:10px;
      display:none;
    }
    .footer {
      margin-top:.9rem; display:flex; justify-content:space-between; align-items:center; gap:.75rem;
    }
    .link { color: var(--brand); text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .hr {
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center;
      gap:.6rem; margin: .9rem 0 .2rem;
    }
    .hr::before, .hr::after { content:""; height:1px; background: rgba(255,255,255,.12); }
    .brand {
      display:flex; align-items:center; gap:.6rem; margin-bottom:.75rem;
    }
    .dot {
      width: 28px; height: 28px; border-radius: 8px;
      background: radial-gradient(95% 95% at 25% 20%, #fff 0%, #dbeafe 15%, #93c5fd 60%, #60a5fa 100%);
      box-shadow: 0 8px 22px rgba(96,165,250,.45);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div style="font-weight:800; letter-spacing:.2px;">Welcome back</div>
        <div class="meta">Sign in to continue to the discussion</div>
      </div>
    </div>

    <div class="card">
      <h1>Sign in</h1>
      <p class="sub">Use your email and password.</p>

      <form id="loginForm" novalidate>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" required placeholder="you@example.com" />

        <label for="password">Password</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />

        <div id="err" class="err" role="alert"></div>

        <div class="footer">
          <a class="link" id="forgotLink" href="forgot.html">Forgot password?</a>
          <button class="btn" type="submit">Sign in</button>
        </div>

        <div class="hr meta"><span>or</span></div>

        <!-- ðŸ”¹ Register option -->
        <div class="row between">
          <span class="meta">New here?</span>
          <a id="registerLink" class="btn ghost" href="register.html">Create an account</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // tiny helpers
    const $ = (s) => document.querySelector(s);
    function getParam(name) {
      const m = new URLSearchParams(location.search).get(name);
      return m ? decodeURIComponent(m) : '';
    }
    function setError(msg) {
      const box = $('#err');
      box.textContent = msg || '';
      box.style.display = msg ? 'block' : 'none';
    }
    function readCookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-./*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    let csrfToken = '';

    async function ensureCsrf() {
      try {
        // Your auth middleware should set the CSRF cookie on this GET
        await fetch('/api/auth/csrf', { credentials: 'include' });
        csrfToken = readCookie('csrf') || '';
      } catch {
        // non-fatal; server may set CSRF on first HTML GET too
        csrfToken = readCookie('csrf') || '';
      }
    }

    // Preserve next=... for register and forgot links
    function wireDeepLinks() {
      const next = getParam('next') || 'threads.html';
      const reg = $('#registerLink');
      const fgt = $('#forgotLink');
      if (reg) reg.href = `register.html?next=${encodeURIComponent(next)}`;
      if (fgt) fgt.href = `forgot.html?next=${encodeURIComponent(next)}`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      wireDeepLinks();
      await ensureCsrf();

      $('#loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        setError('');
        const email = $('#email')?.value.trim();
        const password = $('#password')?.value;
        if (!email || !password) { setError('Please enter your email and password.'); return; }

        const next = getParam('next') || 'threads.html';

        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrfToken ? { 'X-CSRF-Token': csrfToken } : {})
            },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.error) {
            setError(data.error || data.message || 'Invalid email or password.');
            // Try to refresh CSRF for a retry
            await ensureCsrf();
            return;
          }

          // success: go to next (server sets auth cookie)
          location.href = next;
        } catch (err) {
          setError('Network error. Please try again.');
        }
      });
    });
  </script>
</body>
</html>
