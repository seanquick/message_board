  <!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>

  <main class="dashboard-container">
    <h1 class="row between">Admin Dashboard
      <span id="notifBell" class="row items-center" style="gap:.35rem">
        <span class="pill" id="notifCount" style="display:none">0</span>
      </span>
    </h1>
    <div id="adminErr" class="err mt-1" aria-live="polite"></div>


    <!-- Metrics -->
    <section class="grid cols-4 mt-2">
      <div class="stat"><div>Total Users</div><div id="mUsers" class="v">â€”</div></div>
      <div class="stat"><div>Total Threads</div><div id="mThreads" class="v">â€”</div></div>
      <div class="stat"><div>Total Comments</div><div id="mComments" class="v">â€”</div></div>
      <div class="stat"><div>Open Reports</div><div id="mReports" class="v">â€”</div></div>
    </section>

    <!-- Responsive Admin Sections -->
    <div class="dashboard-grid mt-2">
      
      <!-- Global Search -->
<section class="dashboard-box">
  <div class="toolbar between">
    <h2 class="minw-0">Global Search</h2>
    <div class="row itemsâ€‘center" style="gap:.5rem; flex-wrap:wrap">
      <input id="sQ" placeholder="Search textâ€¦" style="min-width:220px" />
      <select id="sType">
        <option value="all">All</option>
        <option value="threads">Threads</option>
        <option value="comments">Comments</option>
        <option value="users">Users</option>
        <option value="reports">Reports</option>
      </select>
      <select id="sStatus">
        <option value="">Any status</option>
        <option value="active">Active</option>
        <option value="deleted">Deleted</option>
        <option value="pinned">Pinned (threads)</option>
        <option value="locked">Locked (threads)</option>
        <option value="open">Open (reports)</option>
        <option value="resolved">Resolved (reports)</option>
      </select>
      <input type="date" id="sFrom" />
      <input type="date" id="sTo" />
      <input id="sMinUp" type="number" min="0" step="1" placeholder="Min upvotes" style="width:110px" />
      <input id="sCategory" placeholder="Category (reports)" style="width:160px" />
      <button id="sGo" class="btn tiny">Search</button>
      <button id="sReset" class="btn tiny">Reset</button>
    </div>
  </div>
  <div class="overflow-auto mt-1">
    <table id="searchTable">
      <thead>
        <tr>
          <th>When</th>
          <th>Type</th>
          <th>Title / Snippet</th>
          <th>Author</th>
          <th>Anon / Real Author</th>
          <th>Upvotes</th>
          <th>Link</th>

        </tr>
      </thead>
      <tbody><tr><td colspan="6" class="empty">Enter a query and press Search.</td></tr></tbody>
    </table>
  </div>
</section>


      <!-- Reports -->
      <section class="dashboard-box">
        <div class="toolbar between">
          <h2 class="minw-0">Reports Queue</h2>
          <div class="row items-center gap-05">
            <label class="row items-center gap-05"><input type="checkbox" id="rGroup" /> <span>Group similar</span></label>
            <select id="rFilter">
              <option value="open">Open</option>
              <option value="resolved">Resolved</option>
              <option value="all">All</option>
            </select>
            <button id="rBulkResolve" class="btn tiny">Resolve selected</button>
            <button id="rExport" class="btn tiny">Export CSV</button>
            <button id="rRefresh" class="btn tiny">Refresh</button>
            <label class="row items-center" style="gap:.35rem"><input type="checkbox" id="rSelectAll" /> <span>Select all</span></label>
          </div>
        </div>
        <div class="overflow-auto mt-1">
          <table id="reportsTable">
            <thead>
              <tr>
                <th></th>
                <th>When</th>
                <th>Type</th>
                <th>Snippet</th>
                <th>Reason</th>
                <th>Reporter</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- Export Section -->
      <section class="dashboard-box">
        <h2>Export / Backup</h2>
        <div id="export-container"></div>
      </section>

  <!-- ===== THREADS Section ===== -->
  <section class="dashboard-box">
    <div class="toolbar between">
      <h2 class="minw-0">Threads</h2>
      <div class="row items-center gap-05">
        <label class="row items-center gap-05">
          <input id="tIncludeDeleted" type="checkbox" />
          <span>Show deleted</span>
        </label>

        <!-- ðŸ”½ Thread Per Page Selector -->
        <select id="tPageSize">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>

        <!-- ðŸ§¾ Optional page info label -->
        <span id="tPageInfo" class="meta">â€”</span>

        <!-- ðŸ§­ Pagination Buttons -->
        <button id="tPrev" class="btn tiny">Prev</button>
        <button id="tNext" class="btn tiny">Next</button>

        <!-- ðŸ—‘ï¸ Bulk Action Buttons -->
        <button id="tBulkDelete" class="btn tiny">Delete Selected</button>
        <button id="tBulkRestore" class="btn tiny">Restore Selected</button>
        <button id="tExport" class="btn tiny">Export CSV</button>
        <button id="tRefresh" class="btn tiny">Refresh</button>
      </div>
    </div>

    <div class="overflow-auto mt-1">
      <table id="threadsTable">
        <thead>
          <tr>
            <th><input id="tSelectAll" type="checkbox" /></th>
            <th>Created</th>
            <th>Title</th>
            <th>Author</th>
            <th>Upvotes</th>
            <th>Comments</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>


<!-- ===== COMMENTS Section ===== -->
<section class="dashboard-box">
  <div class="toolbar between">
    <h2 class="minw-0">Recent Comments</h2>
    <div class="row items-center gap-05">
      <label class="row items-center gap-05">
        <input id="cIncludeDeleted" type="checkbox" />
        <span>Show deleted</span>
      </label>
      <select id="cPageSize">
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>
      <span id="cPageInfo" class="meta">â€”</span>
      <button id="cPrev" class="btn tiny">Prev</button>
      <button id="cNext" class="btn tiny">Next</button>
      <!-- Bulk action buttons -->
      <button id="cBulkDelete" class="btn tiny">Delete Selected</button>
      <button id="cBulkRestore" class="btn tiny">Restore Selected</button>
      <button id="cExport" class="btn tiny">Export CSV</button>
      <button id="cRefresh" class="btn tiny">Refresh</button>
    </div>
  </div>

  <div class="overflow-auto mt-1">
    <table id="commentsTable">
      <thead>
        <tr>
          <th><input id="cSelectAll" type="checkbox" /></th>
          <th>When</th>
          <th>Snippet</th>
          <th>Author</th>
          <th>Thread</th>
          <th>Upvotes</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- If you want a dedicated comments pagination container, you can add: -->
  <div id="commentsPagination" class="pagination row gap-05 mt-1" style="justify-content: center;"></div>
</section>


      <!-- Users -->
      <section class="dashboard-box">
        <div class="toolbar between">
          <h2 class="minw-0">Users</h2>
          <div class="row items-center gap-05">
            <input id="uSearch" placeholder="Search name or emailâ€¦" />
            <select id="uPageSize">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
            <span id="uPageInfo" class="meta">â€”</span>
            <button id="uPrev" class="btn tiny">Prev</button>
            <button id="uNext" class="btn tiny">Next</button>
            <button id="uExport" class="btn tiny">Export CSV</button>
            <button id="uRefresh" class="btn tiny">Search</button>
          </div>
        </div>
        <div class="overflow-auto mt-1">
          <table id="usersTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <!-- âœ… Modal for viewing report details -->
  <div id="adminReportModal">
    <div class="report-backdrop">
      <div class="report-dialog">
        <header><h3>Report Detail</h3></header>
        <section id="reportDetailBody"></section>
        <div style="text-align: right; margin-top: 1rem;">
          <button id="adminReportClose" class="btn tiny">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ§  Shared base logic must load first -->
  <script type="module" src="nav.js"></script>
  <script type="module" src="main.js"></script>

  <!-- ðŸ“Œ Functional logic (uses main.js helpers) -->
  <script type="module" src="threads.js"></script>
  <script type="module" src="account.js"></script>
  <script type="module" src="admin.js"></script>

  <!-- ðŸ§ª Admin extensions -->
  <script type="module" src="/adminExport.js"></script>
  <script type="module" src="/adminTest.js"></script>

  <!-- âœ… New: Comments logic -->
  <script type="module" src="admin-comments.js"></script>


    const state = {
      comments: {
        page: 1,
        limit: 50,
        total: 0,
        totalPages: 1
      }
    };

    async function loadComments({ page = state.comments.page || 1 } = {}) {
      const tbody = document.querySelector('#commentsTable tbody');
      if (!tbody) return;

      const includeDeleted = q('#cIncludeDeleted')?.checked;
      const limit = parseInt(q('#cPageSize')?.value || 50, 10);
      const params = new URLSearchParams({ page, limit, t: Date.now() });
      if (includeDeleted) params.set('includeDeleted', '1');

      try {
        const resp = await api(`/api/admin/comments?${params.toString()}`, { method: 'GET', nocache: true });
        const comments = Array.isArray(resp.comments) ? resp.comments : [];
        const { totalPages = 1, totalCount = 0 } = resp.pagination || {};

        tbody.innerHTML = '';
        if (!comments.length) {
          tbody.innerHTML = `<tr><td colspan="8" class="empty">No comments found.</td></tr>`;
          q('#cPageInfo').textContent = `0 results`;
          return;
        }

        comments.forEach(c => {
          const tr = document.createElement('tr');
          tr.dataset.id = c._id;
          tr.dataset.deleted = !!c.isDeleted;

          const publicAuthor = c.isAnonymous ? 'Anonymous' : (c.author_name || c.author?.name || '');
          const internalAuthor = c.realAuthor ? (c.realAuthor.name || c.realAuthor.email || '') : '';
          const displayAuthor = c.isAnonymous
            ? `${publicAuthor} (internal: ${escapeHTML(internalAuthor)}${c.realAuthor?._id ? `, <a class="btn tiny" href="profile.html?id=${c.realAuthor._id}" target="_blank">View Profile</a>` : ''})`
            : `${escapeHTML(publicAuthor)}${c.realAuthor?._id ? ` <a class="btn tiny" href="profile.html?id=${c.realAuthor._id}" target="_blank">View Profile</a>` : ''}`;

          const threadId = typeof c.thread === 'object' && c.thread?._id ? c.thread._id : (typeof c.thread === 'string' ? c.thread : '');
          const threadTitle = typeof c.thread === 'object' && c.thread?.title ? c.thread.title : '';

          tr.dataset.threadId = threadId || '';
          tr.innerHTML = `
            <td><input type="checkbox" class="bulkSelectComment" /></td>
            <td>${escapeHTML(new Date(c.createdAt || Date.now()).toLocaleString())}</td>
            <td>${escapeHTML(c.snippet || '(no snippet)')}</td>
            <td>${displayAuthor}</td>
            <td>${escapeHTML(threadTitle || threadId || '(unknown thread)')}</td>
            <td>${Number(c.upvoteCount ?? 0)}</td>
            <td>${c.isDeleted ? 'Deleted' : 'Active'}</td>
            <td class="row gap-05">
              <button class="btn tiny viewComment">View</button>
              <button class="btn tiny delRestoreComment">Delete/Restore</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        state.comments.page = page;
        state.comments.limit = limit;
        state.comments.total = totalCount;
        state.comments.totalPages = totalPages;

        q('#cPageInfo').textContent = `Page ${page} of ${totalPages} (${totalCount} comments)`;
        q('#cPrev')?.toggleAttribute('disabled', page <= 1);
        q('#cNext')?.toggleAttribute('disabled', page >= totalPages);

        bindCommentActions(tbody);
      } catch (e) {
        console.error('[Comments] Load error:', e);
        renderErrorRow('#commentsTable', `Error loading comments: ${e?.message || e}`, 8);
      }
    }

    function bindCommentActions(tbody) {
      tbody.querySelectorAll('.viewComment').forEach(btn => btn.addEventListener('click', ev => {
        const tr = ev.currentTarget.closest('tr');
        const tid = tr?.dataset.threadId;
        if (tid) window.open(`thread.html?id=${encodeURIComponent(tid)}`, '_blank');
      }));

      tbody.querySelectorAll('.delRestoreComment').forEach(btn => btn.addEventListener('click', async ev => {
        const tr = ev.currentTarget.closest('tr');
        const cid = tr?.dataset.id;
        if (!cid) return;
        const reason = prompt('Reason (optional):');
        try {
          await api(`/api/admin/comments/${encodeURIComponent(cid)}/delete`, { method: 'POST', body: { reason } });
          loadComments({ page: state.comments.page });
        } catch (e) {
          console.error('[Comment Delete/Restore]', e);
          alert(`Failed to delete/restore comment: ${e?.message || e}`);
        }
      }));
    }

    // Bind pagination and refresh
    q('#cPrev')?.addEventListener('click', () => loadComments({ page: Math.max(1, state.comments.page - 1) }));
    q('#cNext')?.addEventListener('click', () => loadComments({ page: state.comments.page + 1 }));
    q('#cRefresh')?.addEventListener('click', () => loadComments({ page: state.comments.page }));

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      loadComments({ page: 1 });
    });
  </script>

  </body>
  </html>
