<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resend Verification Email</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container narrow pad">
    <h1>Resend Email Verification</h1>
    <p>If you registered but didn’t receive your email, enter your email address below to resend the verification link.</p>

    <form id="resendForm">
      <div>
        <label for="emailInput">Email:</label><br />
        <input type="email" id="emailInput" name="email" required placeholder="you@example.com" />
      </div>
      <button type="submit" class="btn primary mt-2" id="submitBtn">Resend Verification</button>
    </form>

    <p id="infoMsg" class="hidden"></p>
    <p id="errorMsg" class="error hidden"></p>
  </main>

  <script type="module">
    import { q } from './main.js';
    import { ensureCsrf } from './auth-ui.js';

    const form      = q('#resendForm');
    const emailIn   = q('#emailInput');
    const infoMsg   = q('#infoMsg');
    const errorMsg  = q('#errorMsg');
    const submitBtn = q('#submitBtn');

    form.addEventListener('submit', async ev => {
      ev.preventDefault();
      infoMsg.classList.add('hidden');
      errorMsg.classList.add('hidden');

      const email = emailIn.value.trim();
      if (!email) {
        errorMsg.textContent = 'Please enter your email.';
        errorMsg.classList.remove('hidden');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending…';

      try {
        const csrf = await ensureCsrf();
        const res = await fetch('/api/auth/resend-verification', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(csrf ? { 'X-CSRF-Token': csrf } : {})
          },
          credentials: 'include',
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Failed to resend verification email.');

        infoMsg.textContent = data.message || 'Verification email sent. Please check your inbox.';
        infoMsg.classList.remove('hidden');
      } catch (err) {
        errorMsg.textContent = err?.message || 'Failed to resend verification email.';
        errorMsg.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Resend Verification';
      }
    });
  </script>
</body>
</html>
